# TODO: NGINX config

# This will require SSL, HTTPS and WSS to be setup
# Reverse proxy to the backend off /api routes
# Image upload serving from the backend (webp)
# 404 landing page

# TODO: Split configs with environmental variables into an intermediary file and include them here

user  nginx;

worker_processes  auto;

pid /var/run/nginx.pid;

# [ debug | info | notice | warn | error | crit ]
error_log  /var/log/nginx.error_log  warn;

events {
    worker_connections   1024;

    # use [ kqueue | epoll | /dev/poll | select | poll ];
    use epoll;
}

http {

    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format main      '$remote_addr - $remote_user [$time_local] "$request" '
                         '$status $body_bytes_sent "$http_referer"'
                         '"$http_user_agent" "$http_x_forwarded_for"'
                         '"$gzip_ratio"';

    access_log   /var/log/nginx.access_log  main;

    server_tokens                off;
    sendfile                     on;
    tcp_nopush                   on;
    tcp_nodelay                  on;
    keepalive_timeout            60;

    # Limits
    client_max_body_size         5M;
    large_client_header_buffers  4 16k;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/m;
    limit_req_zone $binary_remote_addr zone=ws_handshake:10m rate=5r/s;

    # Connecton limiting
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    limit_conn_zone $binary_remote_addr zone=ws_conn:10m;

    # Gzip compression
    gzip on;
    gzip_min_length  1100;
    gzip_buffers     4 8k;
    gzip_comp_level  6;
    gzip_types       text/plain text/css text/xml text/javascript
                     application/json application/javascript
                     image/svg+xml image/webp;

    # HTTP server (redirects to HTTPS)
    server {
        listen      80;
        listen      [::]:80;
        server_name ${DOMAIN_NAME} www.${DOMAIN_NAME};

        return 301 https://$server_name$request_uri;
    }

    # HTTPS server
    server {
        listen        443 ssl http2;
        listen        [::]:443 ssl http2;
        server_name   ${DOMAIN_NAME} www.${DOMAIN_NAME};

        # SSL config
        ssl_certificate             _; # TODO: generate temporary self-cert
        ssl_certificate_key         _; # TODO: generate temporary self-cert key

        ssl_protocols               TLSv1.2 TLSv1.3;
        ssl_ciphers                 HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers   on;
        ssl_session_tickets         off;
        ssl_session_cache           shared:SSL:10m;
        ssl_session_timeout         10m;

        # Security headers

        # Prevent clickjacking attacks e.g. our site is embedded in another with iframe
        add_header X-Frame-Options "SAMEORIGIN" always;
        # Prevent MIME type sniffing attacks e.g. a javascript file disguised as an uploaded image
        add_header X-Content-Type-Options "nosniff" always;
        # Prevent Cross-Site-Scripting
		add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' wss://${DOMAIN_NAME}/ws https://${DOMAIN_NAME}/api;" always;
        # Prevent credential/cookie hijacking
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";
        # Do not send referer headers to other sites
        add_header Referrer-Policy "no-referrer" always;

        # Connection limit
        limit_conn addr 10;

        # Frontend application
        root  /usr/share/nginx/html;
        index index.html;

        # Database healthcheck
        location /healthcheck {
            proxy_pass  http://backend:4241/healthcheck;
        }

        # Backend HTTP routes
        location /api/ {
            # Rate limiting
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass          http://backend:4241/api/;
            proxy_http_version  1.1;

            proxy_set_header  Host               $host;
            proxy_set_header  X-Real-IP          $remote_addr;
            proxy_set_header  X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header  X-Forwarded-Proto  $scheme;

            proxy_connect_timeout      60s;
            proxy_send_timeout         60s;
            proxy_read_timeout         60s;
        }

        location /api/auth {
            # Rate limiting
            limit_req zone=auth_limit burst=3 nodelay;

            proxy_pass          http://backend:4241/api/auth;
            proxy_http_version  1.1;

            proxy_set_header  Host               $host;
            proxy_set_header  X-Real-IP          $remote_addr;
            proxy_set_header  X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header  X-Forwarded-Proto  $scheme;

            proxy_connect_timeout      60s;
            proxy_send_timeout         60s;
            proxy_read_timeout         60s;
        }

        # Backend WebSocket routes
        location /ws/ {
            proxy_pass          http://backend:4241/ws/;
            proxy_http_version  1.1;

            proxy_set_header  Upgrade            $http_upgrade;
            proxy_set_header  Connection         "upgrade";

            proxy_set_header  Host               $host;
            proxy_set_header  X-Real-IP          $remote_addr;
            proxy_set_header  X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header  X-Forwarded-Proto  $scheme;

            proxy_connect_timeout      7d;
            proxy_send_timeout         7d;
            proxy_read_timeout         7d;
        }

        # Backend avatar fetching with caching
        location ~ ^/api/avatars/.*\.webp$ {
            proxy_pass        http://backend:4241;

            proxy_set_header  Host                   $host;

            add_header        Cache-Control          "public";
            add_header        X-Content-Type-Options "nosniff";

            expires           7d;
        }

        # Frontend asset caching
        location /assets/ {
            access_log        off;

            add_header        Cache-Control          "public, immutable";

            expires           30d;
        }

        # Frontend disable index caching
        location = /index.html {
            expires    -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate";
            add_header Pragma        "no-cache";
        }

        # Frontend index
        location / {
            try_files   $uri $uri/ /index.html;
        }

        # Frontend root level static files
        location ~* ^/[^/]+\.(png|txt|ico|xml)$
        {
            expires         7d;
            access_log      off;
            log_not_found   off;
        }

        # Deny hidden files
        location ~ /\. {
            deny            all;
        }
    }
}
