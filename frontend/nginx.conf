# TODO: NGINX config

# This will require SSL, HTTPS and WSS to be setup
# Reverse proxy to the backend off /api routes
# Image upload serving from the backend (webp)
# 404 landing page

# TODO: Split configs with environmental variables into an intermediary file and include them here

user  nginx;

worker_processes  auto;

pid /var/run/nginx.pid;

# [ debug | info | notice | warn | error | crit ]
error_log  /var/log/nginx.error_log  warn;

events {
    worker_connections   1024;

    # use [ kqueue | epoll | /dev/poll | select | poll ];
    use epoll;
}

http {

    include       /etc/nginx/conf/mime.types;
    default_type  application/octet-stream;

    log_format main      '$remote_addr - $remote_user [$time_local] "$request" '
                         '$status $body_bytes_sent "$http_referer"'
                         '"$http_user_agent" "$http_x_forwarded_for"'
                         '"$gzip_ratio"';

    access_log   /var/log/nginx.access_log  main;

    sendfile             on;
    tcp_nopush           on;
    tcp_nodelay          on;
    keepalive_timeout    60;
    client_max_body_size 5M;

    gzip on;
    gzip_min_length  1100;
    gzip_buffers     4 8k;
    gzip_comp_level  6;
    gzip_types       text/plain text/css text/xml text/javascript
                     applicatiion/json applicatiion/javascript
                     image/svg+xml image/webp;

    # HTTP server (redirects to HTTPS)
    server {
        listen      80;
        listen      [::]:80;
        server_name ${DOMAIN_NAME} www.${DOMAIN_NAME}

        return 301 https://$server_name$request_uri;
    }

    # HTTPS server
    server {
        listen        443 ssl http2;
        listen        [::]:443 ssl http2;
        server_name   ${DOMAIN_NAME} www.${DOMAIN_NAME}

        # SSL config
        ssl_certificate             _; # TODO: generate temporary self-cert
        ssl_certificate_key         _; # TODO: generate temporary self-cert key

        ssl_protocols               TLSv1.2 TLSv1.3;
        ssl_ciphers                 HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers   on;
        ssl_session_tickets         off;
        ssl_session_cache           shared:SSL:10m;
        ssl_session_timeout         10m;

        # Security headers

        # Prevent clickjacking attacks e.g. our site is embedded in another with iframe
        add_header X-Frame-Options "SAMEORIGIN" always;
        # Prevent MIME type sniffing attacks e.g. a javascript file disguised as an uploaded image
        add_header X-Content-Type-Options "nosniff" always;
        # Prevent Cross-Site-Scripting
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' wss://${DOMAIN_NAME};" always;
        # Prevent credential/cookie hijacking
        add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";
        # Do not send referer headers to other sites
        add_header Referrer-Policy "no-referrer" always;

        # Frontend application
        root  /usr/share/nginx/html;
        index index.html;

        # Database healthcheck
        location /healthcheck {
            # Should this be made https even though the communication is internal?
            proxy_pass  http://backend:4241/healthcheck;
        }

        # Backend Hypertext routes
        location /api/ {
            # Don't think we have to construct the port from env
            proxy_pass          http://backend:4241/api/;
            proxy_http_version  1.1;

            proxy_set_header  Host               $host;
            proxy_set_header  X-Real-IP          $remote_addr;
            proxy_set_header  X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header  X-Forwarded-Proto  $scheme;

            proxy_connect_timeout      60s;
            proxy_send_timeout         60s;
            proxy_read_timeout         60s;
        }

        # Backend WebSocket game routes
        location /api/game {
            proxy_pass          http://backend:4241/api/game;
            proxy_http_version  1.1;

            proxy_set_header  Upgrade            $http_upgrade;
            proxy_set_header  Connection         "upgrade";

            proxy_set_header  Host               $host;
            proxy_set_header  X-Real-IP          $remote_addr;
            proxy_set_header  X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header  X-Forwarded-Proto  $scheme;

            proxy_connect_timeout      7d;
            proxy_send_timeout         7d;
            proxy_read_timeout         7d;
        }

        # Backend WebSocket chat routes
        location /api/chat {
            proxy_pass          http://backend:4241/api/chat;
            proxy_http_version  1.1;

            proxy_set_header  Upgrade            $http_upgrade;
            proxy_set_header  Connection         "upgrade";

            proxy_set_header  Host               $host;
            proxy_set_header  X-Real-IP          $remote_addr;
            proxy_set_header  X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header  X-Forwarded-Proto  $scheme;

            proxy_connect_timeout      7d;
            proxy_send_timeout         7d;
            proxy_read_timeout         7d;
        }

        location / {
            try_files   $uri $uri/ /index.html;
        }

        location ~* \.(js|css|png|jpg|jpeg|gif|ico)$
        {
            expires         7d;
            access_log      off;
            log_not_found   off;
        }

        location ~ /\. {
            deny            all;
        }

#        location / {
#            proxy_pass         http://127.0.0.1/;
#            proxy_redirect     off;
#
#            proxy_set_header   Host             $host;
#            proxy_set_header   X-Real-IP        $remote_addr;
#            #proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;
#
#            client_max_body_size       10m;
#            client_body_buffer_size    128k;
#
#            client_body_temp_path      /var/nginx/client_body_temp;
#
#            proxy_connect_timeout      70;
#            proxy_send_timeout         90;
#            proxy_read_timeout         90;
#            proxy_send_lowat           12000;
#
#            proxy_buffer_size          4k;
#            proxy_buffers              4 32k;
#            proxy_busy_buffers_size    64k;
#            proxy_temp_file_write_size 64k;
#
#            proxy_temp_path            /var/nginx/proxy_temp;
#
#            charset  koi8-r;
#        }
#
#        error_page  404  /404.html;
#
#        location = /404.html {
#            root  /spool/www;
#        }
#
#        location /old_stuff/ {
#            rewrite   ^/old_stuff/(.*)$  /new_stuff/$1  permanent;
#        }
#
#        location /download/ {
#
#            valid_referers  none  blocked  server_names  *.example.com;
#
#            if ($invalid_referer) {
#                #rewrite   ^/   http://www.example.com/;
#                return   403;
#            }
#
#            #rewrite_log  on;
#
#            # rewrite /download/*/mp3/*.any_ext to /download/*/mp3/*.mp3
#            rewrite ^/(download/.*)/mp3/(.*)\..*$
#                    /$1/mp3/$2.mp3                   break;
#
#            root         /spool/www;
#            #autoindex    on;
#            access_log   /var/log/nginx-download.access_log  download;
#        }
#
#        location ~* \.(jpg|jpeg|gif)$ {
#            root         /spool/www;
#            access_log   off;
#            expires      30d;
#        }
    }
}
