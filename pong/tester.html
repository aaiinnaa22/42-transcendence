<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fastify WebSocket Test</title>
  <style>
    body { font-family: sans-serif; background: #222; color: #eee; text-align: center; }
    canvas { background: #333; margin-top: 20px; border: 1px solid #666; }
  </style>
</head>
<body>
  <h1>Fastify WebSocket Test</h1>
  <p>Use arrow keys to move your player</p>
  <p id="status">Connecting...</p>
  <canvas id="game" width="1600" height="800"></canvas>

<script>
  const ws = new WebSocket('ws://localhost:4545/ws');
  const status = document.getElementById('status');
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let players = {};
  let ball = { x: 0, y: 0 }; // initialize ball position

  // Connection setup
  ws.onopen = () => {
    status.textContent = "Connected!";
  };

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'state') {
      players = data.players;
      ball = data.ball;
      draw();
    }
  };

  ws.onclose = () => {
    status.textContent = "Disconnected.";
  };

  // Regularly request updates from the server (every 100 ms)
  setInterval(() => {
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'get_state' }));
    }
  }, 10); // 100 ms interval

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Draw players
    for (const id in players) {
      const { x, y } = players[id];
      ctx.fillStyle = 'lime';
      ctx.fillRect(x, y, 10, 10);
    }

    // Draw ball
    const { x, y } = ball;
    ctx.fillStyle = 'red';
    ctx.fillRect(x, y, 10, 10);
  }

  // Send movement commands with arrow keys
  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowUp') sendMove(1, 0, -5);
    if (e.key === 'ArrowDown') sendMove(1, 0, 5);
    if (e.key === 'w') sendMove(2, 0, -5);
    if (e.key === 's') sendMove(2, 0, 5);
  });

  function sendMove(id, dx, dy) {
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'move', id, dx, dy }));
    }
  }
</script>

</body>
</html>


