<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fastify WebSocket Test</title>
  <style>
    body { 
      font-family: sans-serif; 
      background: #222; 
      color: #eee; 
      text-align: center; 
    }
    canvas { 
      background: #333; 
      margin-top: 20px; 
      border: 1px solid #666; 
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    #chat-container {
      margin-top: 30px;
      width: 400px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    #messages {
      height: 150px;
      overflow-y: auto;
      background: #111;
      border: 1px solid #555;
      padding: 10px;
      font-size: 14px;
    }
    #chat-input {
      display: flex;
      margin-top: 5px;
    }
    #chat-input input {
      flex: 1;
      padding: 8px;
      border: none;
      background: #333;
      color: #eee;
    }
    #chat-input button {
      padding: 8px 12px;
      background: #444;
      border: none;
      color: #eee;
      cursor: pointer;
    }
    #chat-input button:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <h1>Fastify WebSocket Test</h1>
  <p>Use arrow keys or W/S to move your players</p>
  <p id="status">Connecting...</p>

  <canvas id="game" width="1600" height="800"></canvas>

  <!-- ðŸ—¨ï¸ Chat UI -->
  <div id="chat-container">
    <div id="messages"></div>
    <div id="chat-input">
      <input type="text" id="messageBox" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    const ws = new WebSocket('ws://localhost:4241/ws');
    const status = document.getElementById('status');
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const messagesDiv = document.getElementById('messages');
    const messageBox = document.getElementById('messageBox');
    const sendBtn = document.getElementById('sendBtn');

    let players = {};
    let ball = { x: 0, y: 0 };

    // ðŸ›°ï¸ Connection setup
    ws.onopen = () => {
      status.textContent = "Connected!";
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
     // console.log("HERE");
      if (data.type === 'state') {
        //console.log("HERE2");
        players = data.players;
        ball = data.ball;
        draw();
      } else if (data.type === 'chat') {
        console.log("HERE");
        addMessage(data.username || 'Player', data.message);
      }
    };

    ws.onclose = () => {
      status.textContent = "Disconnected.";
    };

    // ðŸ“¡ Periodic state requests
    setInterval(() => {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'get_state' }));
      }
    }, 10);

    // ðŸŽ® Drawing
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw players
      for (const id in players) {
        const { x, y } = players[id];
        ctx.fillStyle = 'lime';
        ctx.fillRect(x, y, 10, 10);
      }

      // Draw ball
      const { x, y } = ball;
      ctx.fillStyle = 'red';
      ctx.fillRect(x, y, 10, 10);
    }

    // ðŸŽ® Movement controls
    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowUp') sendMove(1, 0, -5);
      if (e.key === 'ArrowDown') sendMove(1, 0, 5);
      if (e.key === 'w') sendMove(2, 0, -5);
      if (e.key === 's') sendMove(2, 0, 5);
    });

    function sendMove(id, dx, dy) {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'move', id, dx, dy }));
      }
    }

    // ðŸ’¬ Chat logic
    sendBtn.addEventListener('click', sendChat);
    messageBox.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChat();
    });

    function sendChat() {
      const message = messageBox.value.trim();
      if (!message || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'chat', message }));
      messageBox.value = '';
    }

    function addMessage(user, message) {
      const div = document.createElement('div');
      div.textContent = `${user}: ${message}`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  </script>
</body>
</html>
